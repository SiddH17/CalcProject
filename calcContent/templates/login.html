<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Welcome back!{% endblock title %}</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
      crossorigin="anonymous"
    ></script>
    <script src="https://kit.fontawesome.com/bece881ded.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <link rel="stylesheet" href="{% static 'styles/style.css' %}">
</head>
<body>
    {% block content %}
        <div class="enclosingbox">
            <form action ="/" method="post">
                {% csrf_token %}
                <h1>Welcome back, old pal!</h1>
                
                <div class="input-box">
                    <input type="text" class="input-field" id="username" placeholder="Username" autocomplete="off" required>
                    <i class='bx bx-user' ></i>
                    <p id="loginUsername_p"></p>
                </div>
                <div class="input-box">
                    <input type="password" id="loginPassword" class="input-field" placeholder="Password" autocomplete="off" required>
                    <i class='bx bx-lock-alt'></i>
                    <i class='bx bx-show' id='showPassword' style="cursor: pointer; right: 8%;"></i>
                    <i class='bx bx-hide' id='hidePassword' style="cursor: pointer; right: 8%; display: none;"></i>
                </div>
            
                <div class="otherPages">
                    <div class="forgot">
                        <input type="checkbox" id="check">
                        <label for="check" style="color: #A3FFD6;">Remember me</label>
                        <div id="forgotPassword">
                            <label>
                                <a href="#">Forgot Password</a>
                            </label>
                        </div>
                    </div>
                        
                    <div class="input-submit">
                            <button class="submit-btn" id="submit">Sign In</button>
                    </div>
                        
                    <div class="Register-page">
                            <label>Don't have an account?</label>
                            <a href="{% url 'register' %}">Register</a>
                    </div>
                </div>
            </form>     
        </div>

        <script>
            $.getCookie = function(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    $.each(cookies, function(i, cookie) {
                        cookie = $.trim(cookie);
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            return false; // break out of $.each loop
                        }
                    });
                }
                return cookieValue;
            };

            const csrftoken = $.getCookie('csrftoken');

            // JavaScript code for handling login can be added here
            $(document).ready(function() {
                const hidePassword = $('#hidePassword');
                const showPassword = $('#showPassword');
                const loginPassword = $('#loginPassword');
               
                //To show the password and change the type and logo
                showPassword.click(function()   {
                    console.log("In Function showpassword now");
                    loginPassword.attr('type','text');
                    showPassword.css('display', 'none');
                    hidePassword.css('display', 'block');
                });

                //To hide the password and change the type and logo
                hidePassword.click(function() {
                    loginPassword.attr('type', 'password');
                    showPassword.css('display', 'block');
                    hidePassword.css('display', 'none');
                });

                $('#submit').click(function(event) {
                    event.preventDefault();
                    //All input labels, find every input with input-box class
                    var inputs = $('.enclosingbox').find('.input-box .input-field');
                    var data = {};

                    //Parsing through each input
                    inputs.each(function() {
                        var name = $(this).attr('id');
                        var value = $(this).val();
                        data[name] = value;
                    });
                    console.log(data, "The data being passed.");

                    $.ajax({
                        type: "POST",
                        url: "/api/login_api/",
                        headers: {
                            'X-CSRFToken': csrftoken
                        },
                        contentType: "application/json",
                        data: JSON.stringify(data),
                        mode: 'same-origin',
                        success: function(response) {
                            if(response.status === 'success' || response.status === '200')  {
                                console.log(response.message);
                                debugger;
                                window.location.href = '/';
                            }
                        },
                        error: function(xhr)    {
                            const response = xhr.responseJSON;
                            if(response.errors)  {
                                if(response.errors.username)    {
                                    $('#loginUsername_p').text(response.errors.username);
                                }
                            }
                            else    {
                                alert(response.message);
                            }
                        }
                    });
                });
            });
        </script>
    {% endblock content %}    
</body>
</html>
